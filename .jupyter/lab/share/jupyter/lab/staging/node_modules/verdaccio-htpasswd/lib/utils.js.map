{"version":3,"file":"utils.js","names":["DEFAULT_BCRYPT_ROUNDS","HtpasswdHashAlgorithm","lockAndRead","name","cb","readFile","lock","err","res","parseHTPasswd","input","split","reduce","result","line","args","map","str","trim","length","verifyPassword","passwd","hash","match","bcrypt","compare","indexOf","slice","crypto","createHash","update","digest","md5","crypt3","generateHtpasswdLine","user","hashConfig","algorithm","rounds","crypt","sha1","createError","comment","Date","toJSON","addUserToHTPasswd","body","encodeURIComponent","status","newline","sanityCheck","password","verifyFn","users","maxUsers","Error","auth","Object","keys","changePasswordToHTPasswd","newPasswd","lines","userLineIndex","findIndex","shift","username","passwordValid","updatedUserLine","splice","join"],"sources":["../src/utils.ts"],"sourcesContent":["import crypto from 'crypto';\n\nimport md5 from 'apache-md5';\nimport bcrypt from 'bcryptjs';\nimport createError, { HttpError } from 'http-errors';\nimport { readFile } from '@verdaccio/file-locking';\nimport { Callback } from '@verdaccio/types';\n\nimport crypt3 from './crypt3';\n\nexport const DEFAULT_BCRYPT_ROUNDS = 10;\n\nexport enum HtpasswdHashAlgorithm {\n  md5 = 'md5',\n  sha1 = 'sha1',\n  crypt = 'crypt',\n  bcrypt = 'bcrypt',\n}\n\nexport interface HtpasswdHashConfig {\n  algorithm: HtpasswdHashAlgorithm;\n  rounds?: number;\n}\n\n// this function neither unlocks file nor closes it\n// it'll have to be done manually later\nexport function lockAndRead(name: string, cb: Callback): void {\n  readFile(name, { lock: true }, (err, res) => {\n    if (err) {\n      return cb(err);\n    }\n\n    return cb(null, res);\n  });\n}\n\n/**\n * parseHTPasswd - convert htpasswd lines to object.\n * @param {string} input\n * @returns {object}\n */\nexport function parseHTPasswd(input: string): Record<string, any> {\n  // The input is split on line ending styles that are both windows and unix compatible\n  return input.split(/[\\r]?[\\n]/).reduce((result, line) => {\n    const args = line.split(':', 3).map((str) => str.trim());\n    if (args.length > 1) {\n      result[args[0]] = args[1];\n    }\n    return result;\n  }, {});\n}\n\n/**\n * verifyPassword - matches password and it's hash.\n * @param {string} passwd\n * @param {string} hash\n * @returns {Promise<boolean>}\n */\nexport async function verifyPassword(passwd: string, hash: string): Promise<boolean> {\n  if (hash.match(/^\\$2([aby])\\$/)) {\n    return await bcrypt.compare(passwd, hash);\n  } else if (hash.indexOf('{PLAIN}') === 0) {\n    return passwd === hash.slice(7);\n  } else if (hash.indexOf('{SHA}') === 0) {\n    return (\n      crypto\n        .createHash('sha1')\n        // https://nodejs.org/api/crypto.html#crypto_hash_update_data_inputencoding\n        .update(passwd, 'utf8')\n        .digest('base64') === hash.slice(5)\n    );\n  }\n  // for backwards compatibility, first check md5 then check crypt3\n  return md5(passwd, hash) === hash || crypt3(passwd, hash) === hash;\n}\n\n/**\n * generateHtpasswdLine - generates line for htpasswd file.\n * @param {string} user\n * @param {string} passwd\n * @param {HtpasswdHashConfig} hashConfig\n * @returns {Promise<string>}\n */\nexport async function generateHtpasswdLine(\n  user: string,\n  passwd: string,\n  hashConfig: HtpasswdHashConfig\n): Promise<string> {\n  let hash: string;\n\n  switch (hashConfig.algorithm) {\n    case HtpasswdHashAlgorithm.bcrypt:\n      hash = await bcrypt.hash(passwd, hashConfig.rounds || DEFAULT_BCRYPT_ROUNDS);\n      break;\n    case HtpasswdHashAlgorithm.crypt:\n      hash = crypt3(passwd);\n      break;\n    case HtpasswdHashAlgorithm.md5:\n      hash = md5(passwd);\n      break;\n    case HtpasswdHashAlgorithm.sha1:\n      hash = '{SHA}' + crypto.createHash('sha1').update(passwd, 'utf8').digest('base64');\n      break;\n    default:\n      throw createError('Unexpected hash algorithm');\n  }\n\n  const comment = 'autocreated ' + new Date().toJSON();\n  return `${user}:${hash}:${comment}\\n`;\n}\n\n/**\n * addUserToHTPasswd - Generate a htpasswd format for .htpasswd\n * @param {string} body\n * @param {string} user\n * @param {string} passwd\n * @returns {Promise<string>}\n */\nexport async function addUserToHTPasswd(\n  body: string,\n  user: string,\n  passwd: string,\n  hashConfig: HtpasswdHashConfig\n): Promise<string> {\n  if (user !== encodeURIComponent(user)) {\n    const err = createError('username should not contain non-uri-safe characters');\n\n    err.status = 409;\n    throw err;\n  }\n\n  let newline = await generateHtpasswdLine(user, passwd, hashConfig);\n\n  if (body.length && body[body.length - 1] !== '\\n') {\n    newline = '\\n' + newline;\n  }\n  return body + newline;\n}\n\n/**\n * Sanity check for a user\n * @param {string} user\n * @param {object} users\n * @param {string} password\n * @param {Callback} verifyFn\n * @param {number} maxUsers\n * @returns {object}\n */\nexport async function sanityCheck(\n  user: string,\n  password: string,\n  verifyFn: Callback,\n  users: {},\n  maxUsers: number\n): Promise<HttpError | null> {\n  let err;\n\n  // check for user or password\n  if (!user || !password) {\n    err = Error('username and password is required');\n    err.status = 400;\n    return err;\n  }\n\n  const hash = users[user];\n\n  if (maxUsers < 0) {\n    err = Error('user registration disabled');\n    err.status = 409;\n    return err;\n  }\n\n  if (hash) {\n    const auth = await verifyFn(password, users[user]);\n    if (auth) {\n      err = Error('username is already registered');\n      err.status = 409;\n      return err;\n    }\n    err = Error('unauthorized access');\n    err.status = 401;\n    return err;\n  } else if (Object.keys(users).length >= maxUsers) {\n    err = Error('maximum amount of users reached');\n    err.status = 403;\n    return err;\n  }\n\n  return null;\n}\n\n/**\n * changePasswordToHTPasswd - change password for existing user\n * @param {string} body\n * @param {string} user\n * @param {string} passwd\n * @param {string} newPasswd\n * @param {HtpasswdHashConfig} hashConfig\n * @returns {Promise<string>}\n */\nexport async function changePasswordToHTPasswd(\n  body: string,\n  user: string,\n  passwd: string,\n  newPasswd: string,\n  hashConfig: HtpasswdHashConfig\n): Promise<string> {\n  let lines = body.split('\\n');\n  const userLineIndex = lines.findIndex((line) => line.split(':', 1).shift() === user);\n  if (userLineIndex === -1) {\n    throw new Error(`Unable to change password for user '${user}': user does not currently exist`);\n  }\n  const [username, hash] = lines[userLineIndex].split(':', 2);\n  const passwordValid = await verifyPassword(passwd, hash);\n  if (!passwordValid) {\n    throw new Error(`Unable to change password for user '${user}': invalid old password`);\n  }\n  const updatedUserLine = await generateHtpasswdLine(username, newPasswd, hashConfig);\n  lines.splice(userLineIndex, 1, updatedUserLine);\n  return lines.join('\\n');\n}\n"],"mappings":"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"}